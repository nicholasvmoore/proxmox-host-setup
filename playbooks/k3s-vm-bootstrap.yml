---
- name: Wait for k3s VMs cloud-init
  hosts: prox0.pcola.moorenix.com
  gather_facts: false

  vars_files:
    - ../vars/k3s_vars.yml

  tasks:
    - name: Wait for k3s VM cloud-init to complete first boot
      ansible.builtin.shell: |
        /usr/sbin/qm guest exec {{ item }} -- /bin/sh -c 'ls /var/lib/cloud/instance/boot-finished 2>/dev/null | wc -l | tr -d \n' | jq -r '."out-data"' | tr -d '\n '
      become: true
      register: boot_check
      until: boot_check.stdout == "1"
      retries: 60
      delay: 10
      changed_when: false
      loop: "{{ k3s_vmids }}"

- name: Restart k3s VMs to complete bootstrapping
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - ../vars/proxmox_vars.yml
    - ../vars/k3s_vars.yml

  vars:
    proxmox_host: prox0.pcola.moorenix.com
    node: prox0

  tasks:
    - name: Restart k3s VMs
      community.proxmox.proxmox_kvm:
        api_host: "{{ proxmox_host }}"
        api_user: "{{ lookup('env', 'PROXMOX_API_USER') | default(api_user, true) | default('root@pam') }}"
        api_token_id: "{{ lookup('env', 'PROXMOX_API_TOKEN_ID') | default(api_token_id, true) | default('automation') }}"
        api_token_secret: "{{ lookup('env', 'PROX0_API_TOKEN_SECRET') | default(prox0_api_token_secret, true) }}"
        node: "{{ node }}"
        vmid: "{{ item.vmid }}"
        state: restarted
      loop: "{{ k3s_nodes }}"

- name: Get k3s node IP addresses and add to inventory
  hosts: prox0.pcola.moorenix.com
  gather_facts: false

  vars_files:
    - ../vars/k3s_vars.yml

  tasks:
    - name: Wait for VMs to be fully booted after restart
      ansible.builtin.pause:
        seconds: 30

    - name: Get IP address from qemu-guest-agent
      ansible.builtin.shell: |
        /usr/sbin/qm guest cmd {{ item.vmid }} network-get-interfaces | jq -r '.[] | select(.name=="eth0") | ."ip-addresses"[] | select(.["ip-address-type"]=="ipv4") | .["ip-address"]'
      become: true
      register: vm_ips
      until: vm_ips.stdout != ""
      retries: 10
      delay: 5
      loop: "{{ k3s_nodes }}"
      changed_when: false

    - name: Add k3s nodes to dynamic inventory groups
      ansible.builtin.add_host:
        name: "{{ item.item.hostname }}"
        ansible_user: nicholas
        groups:
          - k3s_nodes_dynamic
          - "k3s_{{ item.item.role }}s"
      loop: "{{ vm_ips.results }}"
      delegate_to: localhost

    - name: Display k3s node connectivity
      ansible.builtin.debug:
        msg: "{{ item.item.name }} ({{ item.item.hostname }}) is reachable at IP: {{ item.stdout }}"
      loop: "{{ vm_ips.results }}"

- name: Verify hostname resolution
  hosts: k3s_nodes_dynamic
  gather_facts: false

  tasks:
    - name: Test DNS resolution for all cluster nodes
      ansible.builtin.command: "getent hosts {{ item }}"
      loop: "{{ groups['k3s_servers'] }}"
      register: dns_check
      failed_when: dns_check.rc != 0

    - name: Display DNS resolution results
      ansible.builtin.debug:
        msg: "DNS resolution successful for {{ item.item }}"
      loop: "{{ dns_check.results }}"
      when: dns_check.rc == 0

- name: Wait for k3s cluster nodes to be online
  hosts: k3s_nodes_dynamic
  gather_facts: false

  tasks:
    - name: Wait for k3s node to be online
      ansible.builtin.wait_for_connection:
        timeout: 300
